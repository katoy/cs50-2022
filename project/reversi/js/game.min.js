(function(){var h,c,d,j,a,i,e,b,g=function(n,l){for(var k in l){if(f.call(l,k)){n[k]=l[k]}}function m(){this.constructor=n}m.prototype=l.prototype;n.prototype=new m();n.__super__=l.prototype;return n},f={}.hasOwnProperty;b=(function(){var l,m,k;n.STONE_IMAGE_WIDTH=50;n.STONE_IMAGE_HEIGHT=50;n.VOID="images/void.jpg";n.BLACK="images/black.jpg";n.WHITE="images/white.jpg";n.HINT_B="images/hintB.jpg";n.HINT_W="images/hintW.jpg";l=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];function n(p,q,o){this.gameSize=q!=null?q:8;this.stoneDispWidth=o!=null?o:1;this.fps=p.fps;this.num_stone=this.gameSize*this.gameSize;this.scale=this.stoneDispWidth/n.STONE_IMAGE_WIDTH;this.SPRITES=[];this.BoardState=[];this.turn=1;this.start=false;this.BlackStone=this.WhiteStone=0;this.players=[0,0];this.records=[];this.play_pos=0;this.replay_mode=false;p.preload([n.VOID,n.BLACK,n.WHITE,n.HINT_B,n.HINT_W])}n.prototype.setCPUs=function(o){this.cpus=o};n.prototype.isInBoard=function(o,p){return(o>=0)&&(o<this.gameSize)&&(p>=0)&&(p<this.gameSize)};n.prototype.xy2pos=function(o,p){return o+p*this.gameSize};n.prototype.pos2xy=function(o){return[o%this.gameSize,Math.floor(o/this.gameSize)]};n.prototype._getSprite=function(u){var w,p,s,r,q,o,v,t;p=[n.STONE_IMAGE_WIDTH,n.STONE_IMAGE_HEIGHT],o=p[0],w=p[1];q=new Sprite(o,w);q.image=new Surface(o*5,w);q.pos=u;s=this.pos2xy(u),v=s[0],t=s[1];q.frame=0;q.scale(this.scale,this.scale);r=[v*o*this.scale,t*w*this.scale],q.x=r[0],q.y=r[1];q.image.draw(enchant.Game.instance.assets[n.VOID],0,0,o,w,0,0,o,w);q.image.draw(enchant.Game.instance.assets[n.BLACK],0,0,o,w,o,0,o,w);q.image.draw(enchant.Game.instance.assets[n.WHITE],0,0,o,w,o*2,0,o,w);q.image.draw(enchant.Game.instance.assets[n.HINT_B],0,0,o,w,o*3,0,o,w);q.image.draw(enchant.Game.instance.assets[n.HINT_W],0,0,o,w,o*4,0,o,w);return q};n.prototype.createBoard=function(){var o,q,p;this.SPRITES=[];for(q=o=0,p=this.num_stone;0<=p?o<p:o>p;q=0<=p?++o:--o){this.SPRITES.push(this._getSprite(q))}this.firstScene();return this.SPRITES};n.prototype.firstScene=function(){var r,p,o,q;for(p=o=0,q=this.num_stone;0<=q?o<q:o>q;p=0<=q?++o:--o){this.SPRITES[p].frame=0;this.BoardState[p]=0}r=this.gameSize*(Math.floor(this.gameSize/2-1))+Math.floor(this.gameSize/2-1);this.SPRITES[r].frame=this.SPRITES[r+this.gameSize+1].frame=2;this.BoardState[r]=this.BoardState[r+this.gameSize+1]=-1;this.SPRITES[r+1].frame=this.SPRITES[r+this.gameSize].frame=1;this.BoardState[r+1]=this.BoardState[r+this.gameSize]=1;this.BlackStone=this.WhiteStone=2;return document.myForm.black.value=document.myForm.white.value=2};n.prototype.checkInvert=function(){var I,z,H,G,v,t,F,E,D,p,o,B,A,w,u,s,C,r,q;z=[];C=(-1)*this.turn;for(p=E=0,o=this.num_stone;0<=o?E<o:E>o;p=0<=o?++E:--E){if(this.BoardState[p]===0){B=this.pos2xy(p),r=B[0],q=B[1];for(F=D=0,A=l.length;0<=A?D<A:D>A;F=0<=A?++D:--D){w=[l[F][0],l[F][1]],v=w[0],t=w[1];u=[1,v,t],I=u[0],H=u[1],G=u[2];while(this.isInBoard(r+H,q+G)&&(this.BoardState[this.xy2pos(r+H,q+G)]===C)){s=[I+1,H+v,G+t],I=s[0],H=s[1],G=s[2]}if(this.isInBoard(r+H,q+G)&&(this.BoardState[this.xy2pos(r+H,q+G)]===this.turn)&&(I>1)){this.BoardState[p]=2;this.SPRITES[p].frame=((this.turn>0)?3:4);z.push(p);break}}}}return z};n.prototype.showStone=function(r,t){var v,s,q,p,o,u;if(t==null){t={delay:0,turn:this.turn}}s=[null,null],o=s[0],u=s[1];if(t.pos){q=this.pos2xy(t.pos),o=q[0],u=q[1];p=[o+1,u+1],o=p[0],u=p[1]}v=(t.turn===1)?1:2;if((this.players[0]>0&&this.players[1]>0)||(this.replay_mode===true)){return r.frame=v}else{if(r.frame!==0){return r.tl.delay(t.delay*this.fps).scaleTo(0.1*this.scale,this.scale,0.2*this.fps).then(function(){return this.frame=v}).scaleTo(this.scale,this.scale,this.fps*0.2)}else{return r.tl.delay(t.delay*this.fps).then(function(){return this.frame=v})}}};n.prototype.putStone=function(r,H){var P,E,Q,p,N,M,C,B,L,K,J,q,G,F,D,A,w,u,s,z,O,o,I,v,t;if(H==null){H={delay:0,turn:this.turn}}if(!this.start){return m("Click [start]")}else{if((this.replay_mode===false)&&(this.BoardState[r]!==2)){return m("can not move")}else{for(L=K=0,q=this.num_stone;0<=q?K<q:K>q;L=0<=q?++K:--K){if(this.BoardState[L]===2){this.BoardState[L]=0;this.SPRITES[L].frame=0}}G=this.pos2xy(r),v=G[0],t=G[1];m("move at ("+(v+1)+", "+(t+1)+")");this.recordPlay([this.turn,v+1,t+1]);I=(-1)*this.turn;for(L=J=0,F=l.length;0<=F?J<F:J>F;L=0<=F?++J:--J){D=[l[L][0],l[L][1]],C=D[0],B=D[1];A=[1,C,B],P=A[0],N=A[1],M=A[2];while(this.isInBoard(v+N,t+M)&&(this.BoardState[this.xy2pos(v+N,t+M)]===I)){w=[P+1,N+C,M+B],P=w[0],N=w[1],M=w[2]}if(this.isInBoard(v+N,t+M)&&(this.BoardState[this.xy2pos(v+N,t+M)]===this.turn)){u=[P-1,N-C,M-B],P=u[0],N=u[1],M=u[2];while(P>0){this.BoardState[this.xy2pos(v+N,t+M)]=this.turn;if(this.turn>0){this.BlackStone++;this.WhiteStone--}else{this.WhiteStone++;this.BlackStone--}o=this.xy2pos(v+N,t+M);this.showStone(this.SPRITES[o],{delay:H.delay+0.3,turn:this.turn,pos:o});s=[P-1,N-C,M-B],P=s[0],N=s[1],M=s[2]}}}this.BoardState[r]=this.turn;if(!this.SPRITES[r]){alert(r)}this.showStone(this.SPRITES[r],{delay:H.delay,turn:this.turn,pos:r});if(this.turn>0){this.BlackStone++}else{this.WhiteStone++}document.myForm.black.value=this.BlackStone;document.myForm.white.value=this.WhiteStone;this.turn*=-1;E=this.checkInvert();if(E.length===0){m(this.turn>0?"Pass first palyer":"Pass second player");this.recordPlay([this.turn,0,0]);this.turn*=-1;E=this.checkInvert();if(E.length===0){k("Restart");z=this.gameResult();O=z===0?"Draw":z>0?"Black win":"White win";m("game over ("+O+")");return}}if(((this.turn===1&&this.players[0]>0)||(this.turn===-1&&this.players[1]>0))&&(this.replay_mode===false)){Q=this.turn===1?this.players[0]-1:this.players[1]-1;p=this.cpus[Q].play(this.BoardState.slice(0),{turn:this.turn,canPuts:E.slice(0)});if(p!==null){this.putStone(p,{delay:H.delay+0.8,turn:this.turn})}}return null}}};n.prototype.gameResult=function(){var p,o,u,t,q;u=0;t=this.BoardState;for(p=0,o=t.length;p<o;p++){q=t[p];u+=q}return u};n.prototype.recordPlay=function(o){if(!this.replay_mode){if(this.play_pos!==this.records.length){this.records=this.records.slice(0,this.play_pos)}this.records.push(o);return this.play_pos=this.records.length}};n.prototype.exitReplay=function(){return this.replay_mode=false};n.prototype.replay=function(t,o){var q,p,s,r;this.replay_mode=true;this.firstScene();this.turn=1;if(o<0){o=0}if(o>t.length){o=t.length}if(o>0){for(q=p=0,r=o;0<=r?p<r:p>r;q=0<=r?++p:--p){s=(t[q][1]-1)+(t[q][2]-1)*this.gameSize;if(s>=0){this.turn=t[q][0];this.putStone(s)}}}if(o<=0){m("init board")}this.play_pos=o;return this.replay_mode=false};n.prototype.historyTop=function(){return this.replay(this.records,0)};n.prototype.historyLast=function(){return this.replay(this.records,this.records.length)};n.prototype.history=function(o){return this.replay(this.records,this.play_pos+o)};n.prototype.savePlay=function(){return alert(JSON.stringify({black:this.BlackStone,white:this.WhiteStone,play:this.records}))};n.prototype.loadPlay=function(){return console.log("未実装")};n.prototype.setPlayers=function(){return this.players=[document.myForm.first.selectedIndex,document.myForm.second.selectedIndex]};n.prototype.gameStart=function(){var o;if(!this.start){this.setPlayers();this.start=true;this.records=[];this.play_pos=0;m("game start");k("restart");o=this.checkInvert();if(this.players[0]>0&&o.length>0){return this.putStone(this.cpus[this.players[0]-1].play(this.BoardState.slice(0),{turn:this.turn,canPuts:o.slice(0)}))}}else{if(confirm("Do you really want to restart?")){this.firstScene();this.turn=1;this.start=false;k("start");return m("restart")}}};m=function(o){return document.myForm.myMsg.value=o};k=function(o){return document.myForm.start.value=o};return n})();enchant();window.onload=function(){var k,m,l,n;l=8;m=320;k=new Core(m+10,m+10);n=new b(k,l,Math.floor(m/l));this.reversi=n;n.setCPUs([new c(),new i(),new d(),new j(),new a(2),new a(3),new a(4),new a(5)].slice(0));k.onload=function(){var s,p,o,q,r;s=n.createBoard();q=[];for(p=0,o=s.length;p<o;p++){r=s[p];k.rootScene.addChild(r);q.push(r.addEventListener("touchend",function(){n.exitReplay();n.setPlayers();return n.putStone(this.pos)}))}return q};return k.start()};h=(function(){var l;function k(){}l=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];k.prototype.numStone=64;k.prototype.gameSize=8;k.prototype.play=function(n,m){if(m==null){m={}}};k.prototype.xy2pos=function(m,n){return m+n*this.gameSize};k.prototype.pos2xy=function(m){return[m%this.gameSize,Math.floor(m/this.gameSize)]};k.prototype.isInBoard=function(m,n){return(m>=0)&&(m<this.gameSize)&&(n>=0)&&(n<this.gameSize)};k.prototype.putStone=function(H,n,v,p){var J,I,G,z,u,o,F,E,m,C,B,A,w,t,r,D,s,q;if(p==null){p=false}if(H[n]!==0){return -1}D=v*(-1);o=0;m=this.pos2xy(n),s=m[0],q=m[1];for(F=E=0,C=l.length;0<=C?E<C:E>C;F=0<=C?++E:--E){B=[l[F][0],l[F][1]],z=B[0],u=B[1];A=[1,z,u],J=A[0],I=A[1],G=A[2];while(this.isInBoard(s+I,q+G)&&(H[this.xy2pos(s+I,q+G)]===D)){w=[J+1,I+z,G+u],J=w[0],I=w[1],G=w[2]}if(this.isInBoard(s+I,q+G)&&H[this.xy2pos(s+I,q+G)]===v){t=[J-1,I-z,G-u],J=t[0],I=t[1],G=t[2];while(J>0){if(p){H[this.xy2pos(s+I,q+G)]=v}r=[J-1,I-z,G-u],J=r[0],I=r[1],G=r[2];o++}}}if(p){H[n]=v}return o};k.prototype.checkInvert=function(o,t){var I,z,H,G,v,s,F,E,D,n,m,B,A,w,u,r,C,q,p;z=[];C=(-1)*t;for(n=E=0,m=this.numStone;0<=m?E<m:E>m;n=0<=m?++E:--E){if(o[n]===0){B=this.pos2xy(n),q=B[0],p=B[1];for(F=D=0,A=l.length;0<=A?D<A:D>A;F=0<=A?++D:--D){w=[l[F][0],l[F][1]],v=w[0],s=w[1];u=[1,v,s],I=u[0],H=u[1],G=u[2];while(this.isInBoard(q+H,p+G)&&(o[this.xy2pos(q+H,p+G)]===C)){r=[I+1,H+v,G+s],I=r[0],H=r[1],G=r[2]}if(this.isInBoard(q+H,p+G)&&(o[this.xy2pos(q+H,p+G)]===t)&&(I>1)){z.push(n);break}}}}return z};return k})();c=(function(){function k(){}k.prototype.play=function(m,l){if(l==null){l={}}if(l.canPuts.length===0){return null}else{return l.canPuts[0]}};return k})();i=(function(){function k(){}k.prototype.play=function(m,l){if(l==null){l={}}if(l.canPuts.length===0){return null}else{return l.canPuts[Math.floor(Math.random()*l.canPuts.length)]}};return k})();d=(function(l){g(k,l);function k(){}k.prototype.play=function(n,m){var z,v,q,u,t,r,s,y,o,w,p,x;if(m==null){m={}}x=m.turn;z=null;q={};v=-1;for(u=t=0,o=this.numStone;0<=o?t<o:t>o;u=0<=o?++t:--t){if(n[u]===2){n[u]=0}}w=m.canPuts;for(r=0,s=w.length;r<s;r++){y=w[r];p=this.putStone(n,y,x,false);if(v<p){v=p}if(q[p]){q[p].push(y)}else{q[p]=[y]}}console.log("#--- AI_gains ");console.log(q);y=v<=0?nyll:q[v][Math.floor(Math.random()*q[v].length)];console.log("#--- AI_Gain turn:"+x+", pos:"+y);return y};return k})(h);j=(function(m){var l;g(k,m);function k(){return k.__super__.constructor.apply(this,arguments)}l=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];k.prototype.numStone=64;k.prototype.gameSize=8;k.prototype.playCount=5;k.prototype.play=function(E,x){var z,n,D,C,B,A,s,y,r,q,w,v,t,o,H,G,F,u;if(x==null){x={}}t=x.turn;z=null;F={};H=-1;for(D=C=0,q=this.numStone;0<=q?C<q:C>q;D=0<=q?++C:--C){if(E[D]===2){E[D]=0}}H=-1;F={};w=x.canPuts;for(B=0,s=w.length;B<s;B++){r=w[B];o=0;n=0;for(y=A=0,v=this.playCount;0<=v?A<v:A>v;y=0<=v?++A:--A){u=E.slice(0);G=this.playGame(u,t,r);if(G===t){o++}if(G===0){n++}}if(o===0&&n===0){o=-1}if(F[o]){F[o].push(r)}else{F[o]=[r]}if(H<o){H=o}}console.log("#--- AI_Montecarlo(playCount="+this.playCount+" turn:"+t+", pos:"+F[H][0]);return F[H][0]};k.prototype.playGame=function(s,u,t){var n,q,o,p,v,r;v=0;while(v<2){if(t>=0){this.putStone(s,t,u,true)}u*=-1;n=this.checkInvert(s,u);if(n.length===0){t=null;v++}else{t=n[Math.floor(Math.random()*n.length)];v=0}}r=0;for(o=0,p=s.length;o<p;o++){q=s[o];r+=q}if(r===0){return 0}if(r>0){return 1}else{return -1}};return k})(h);e=(function(){function k(){}k.rate9=[127,-32,0,-1,-1,-1,0,-32,127,-32,-64,-1,-1,-1,-1,-1,-64,-32,0,-1,0,-1,-1,-1,0,-1,0,-1,-1,-1,0,0,0,-1,-1,-1,-1,-1,-1,0,0,0,-1,-1,-1,-1,-1,-1,0,0,0,-1,-1,-1,0,-1,0,-1,-1,-1,0,-1,0,-32,-64,-1,-1,-1,-1,-1,-64,-32,127,-32,0,-1,-1,-1,0,-32,127];k.rate8=[127,-32,0,-1,-1,0,-32,127,-32,-64,-1,-1,-1,-1,-64,-32,0,-1,0,-1,-1,0,-1,0,-1,-1,-1,0,0,-1,-1,-1,-1,-1,-1,0,0,-1,-1,-1,0,-1,0,-1,-1,0,-1,0,-32,-64,-1,-1,-1,-1,-64,-32,127,-32,0,-1,-1,0,-32,127];k.rate7=[127,-32,0,-1,0,-32,127,-32,-64,-1,-1,-1,-64,-32,0,-1,0,-1,0,-1,0,-1,-1,-1,0,-1,-1,-1,0,-1,0,-1,0,-1,0,-32,-64,-1,-1,-1,-64,-32,127,-32,0,-1,0,-32,127];k.rate6=[127,-32,0,0,-32,127,-32,-64,-1,-1,-64,-32,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-32,-64,-1,-1,-64,-32,127,-32,0,0,-32,127];k.rate5=[127,-32,0,-32,127,-32,-64,-1,-64,-32,0,-1,0,-1,0,-32,-64,-1,-64,-32,127,-32,0,-32,127];k.rate4=[127,-32,-32,127,-32,-64,-64,-32,-32,-64,-64,-32,127,-32,-32,127];k.evalBoard=function(s,l,q){var p,o,u,t,m,r,n;t=k["rate"+l];n=0;if(q==="gain"){for(u=p=0,m=t.length;0<=m?p<m:p>m;u=0<=m?++p:--p){n+=s[u]}}else{for(u=o=0,r=t.length;0<=r?o<r:o>r;u=0<=r?++o:--o){n+=s[u]*t[u]}}return n};return k})();a=(function(k){g(l,k);function l(n,m){this.depth=n!=null?n:5;this.gameSize=m!=null?m:8;l.__super__.constructor.call(this)}l.prototype.play=function(o,m){var r,s,q,t,n,x,z,p,u,w,y;if(m==null){m={}}w=m.turn;n=0;for(s=q=0,p=this.numStone;0<=p?q<p:q>p;s=0<=p?++q:--q){if(o[s]===2){o[s]=0}if(o[s]===0){n++}}r=this.depth;t="";if(n<=10){t="gain";r=n}u=this.negaMax(r,o,w,t),y=u[0],z=u[1];x=z[Math.floor(Math.random()*z.length)];console.log("#--- AI_Negamax(depth="+this.depth+" turn:"+w+", pos:"+x+", v="+y);return x};l.prototype.negaMax=function(q,x,z,t){var u,m,n,r,p,o,s,y,A,w;if(q===0){return[e.evalBoard(x,this.gameSize,t)*z,null]}m=-32000;u={};w=x.slice(0);n=this.checkInvert(w,z);for(p=0,o=n.length;p<o;p++){y=n[p];s=w.slice(0);this.putStone(s,y,z,true);r=this.negaMax(q-1,s,(-1)*z,t);A=(-1)*r[0];if(u[A]){u[A].push(y)}else{u[A]=[y]}if(m<=A){m=A}}return[m,u[m]]};return l})(h)}).call(this);